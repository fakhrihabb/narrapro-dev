{% block extra_head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm position-relative" style="z-index:1060;">
	<div class="container d-flex align-items-center">
		<a class="navbar-brand fw-bold" href="{% url 'main:home' %}" style="margin-right:50px;">
			NarraPro
		</a>

		<!-- Search Field -->
		<form class="flex-grow-1 position-relative" style="max-width: 600px;">
			<div class="input-group rounded-pill overflow-hidden bg-white">
				<span class="input-group-text bg-white border-0">
					<i class="bi bi-search text-muted"></i>
				</span>
				<input 
					id="globalSearch"
                    type="text" 
                    class="form-control border-0 shadow-none" 
                    placeholder="Cari lowongan, event, dan narasumber" 
                    aria-label="Search"
                    value="{{ request.GET.q|default:'' }}"
				/>
			</div>

			<!-- Popup Preview (menempel ke search bar) -->
			<div id="searchPopup" 
				class="position-absolute start-0 mt-2 w-100 bg-white rounded-3 shadow-lg d-none" 
				style="max-height: 300px; overflow-y: auto; z-index:1060;">
				<ul class="list-group list-group-flush">
					<li class="list-group-item">ðŸ”Ž Hasil pencarian akan muncul di sini...</li>
					<li class="list-group-item">Lowongan: Backend Developer</li>
					<li class="list-group-item">Event: Konferensi AI 2025</li>
					<li class="list-group-item">Narasumber: Budi Santoso</li>
				</ul>
			</div>
		</form>

		<!-- Navigation Links -->
		<div class="navbar-nav ms-3">
			<a class="nav-link" href="{% url 'lowongan:list' %}">Browse Lowongan</a>
			{% if user.is_authenticated %}
				{% if user.user_type == 'event' %}
					<a class="nav-link" href="{% url 'lowongan:my_lowongan' %}">My Lowongan</a>
				{% elif user.user_type == 'narasumber' %}
					<a class="nav-link" href="{% url 'lowongan:my_applications' %}">My Applications</a>
				{% endif %}
			{% endif %}
		</div>

		<div class="navbar-nav ms-auto">
			{% if user.is_authenticated %}
				<span class="navbar-text me-3">
					Hello, {{ user.first_name|default:user.username }}!
				</span>
				<a class="nav-link" href="{% url 'main:logout' %}">Logout</a>
			{% else %}
				<a class="nav-link" href="{% url 'main:login' %}">Login</a>
				<a class="nav-link" href="{% url 'main:register' %}">Register</a>
			{% endif %}
		</div>
	</div>
</nav>

<!-- Overlay -->
<div id="overlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50" style="z-index:1050;"></div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("globalSearch");
    const popup = document.getElementById("searchPopup");
    const overlay = document.getElementById("overlay");

    let typingTimer;

    const loadingTemplate = `
        <div class="d-flex justify-content-center align-items-center p-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;

    const successTemplate = `
        <ul class="list-group list-group-flush">
            <li class="list-group-item">Lowongan: Backend Developer</li>
            <li class="list-group-item">Event: Konferensi AI 2025</li>
            <li class="list-group-item">Narasumber: Budi Santoso</li>
        </ul>
    `;

    // Show popup + overlay on focus
    searchInput.addEventListener("focus", () => {
        popup.classList.remove("d-none");
        overlay.classList.remove("d-none");
        popup.innerHTML = successTemplate;
    });

    // On input typing â†’ debounce
    searchInput.addEventListener("input", () => {
        clearTimeout(typingTimer);

        typingTimer = setTimeout(() => {
            const query = searchInput.value.trim();
            if (!query) {
                popup.innerHTML = successTemplate;
                return;
            }

            popup.innerHTML = loadingTemplate;

            fetch(`/search/preview/?q=${encodeURIComponent(query)}`)
                .then((res) => res.json())
                .then((data) => {
                    if (data.results && data.results.length > 0) {
                        let html = `<ul class="list-group list-group-flush">`;
                        data.results.forEach((item) => {
                            html += `
                                <li class="list-group-item">
                                    <strong>[${item.type}]</strong> ${item.title}<br/>
                                    <small class="text-muted">${item.subtitle || ""}</small>
                                </li>
                            `;
                        });
                        html += `</ul>`;
                        popup.innerHTML = html;
                    } else {
                        popup.innerHTML = `
                            <div class="p-3 text-muted">Tidak ada hasil ditemukan</div>
                        `;
                    }
                })
                .catch(() => {
                    popup.innerHTML = `
                        <div class="p-3 text-danger">Terjadi kesalahan</div>
                    `;
                });
        }, 1000);
    });

    searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
        e.preventDefault();
        const query = searchInput.value.trim();
        if (query.length > 0) {
            // ambil semua query params yang ada
            const params = new URLSearchParams(window.location.search);

            // update q dengan yang baru
            params.set("q", query);

            // reset page ke 1 biar hasil konsisten
            params.delete("page");

            // redirect dengan params baru
            window.location.href = `/search/result/?${params.toString()}`;
        }
    }
});

    overlay.addEventListener("click", () => {
        popup.classList.add("d-none");
        overlay.classList.add("d-none");
    });

    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            popup.classList.add("d-none");
            overlay.classList.add("d-none");
            searchInput.blur();
        }
    });
});

</script>
