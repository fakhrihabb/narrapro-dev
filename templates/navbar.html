{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    .navbar-custom {
        background-color: #e3e2e2 !important;
        border-bottom: 1px #939393;
    }
    .navbar-custom .nav-link {
        color: #000000;
        transition: color 0.2s ease;
    }
    .navbar-custom .nav-link:hover,
    .navbar-custom .dropdown-item:hover {
        color: #0e1e7a !important;
    }

    /* Hover show dropdown (desktop) */
    @media (min-width: 992px) {
        .user-dropdown:hover .dropdown-menu {
            display: block;
            margin-top: 0;
            right: 0;
        }
    }
    .user-dropdown .dropdown-menu {
        margin-top: 0;
        border-radius: 0.5rem;
    }

    .btn-create {
        background-color: #0e1e7a;
        color: #fff !important;
        border-radius: 20px;
        padding: 6px 14px;
        font-size: 0.9rem;
        transition: 0.2s;
    }
    .btn-create:hover {
        background-color: #fff;
        color: #0e1e7a !important;
        border: 1px solid #0e1e7a;
    }

    /* Hide brand text on mobile */
    @media (max-width: 991.98px) {
        .navbar-brand span {
            display: none;
        }
    }

    /* Search field rapat ke logo */
    .navbar .navbar-brand {
        margin-right: 10px !important;
    }
    .navbar form {
        margin-left: 0 !important;
    }

    /* Mobile: search full width, sisakan tombol menu */
    @media (max-width: 991.98px) {
        .navbar .navbar-brand {
            margin-right: 6px !important;
        }
        .navbar form {
            flex: 1 1 auto;
            max-width: none !important;
        }
    }
</style>
{% endblock %}

<nav class="navbar navbar-expand-lg navbar-light navbar-custom shadow-sm position-relative" style="z-index:1060;">
    <div class="container d-flex align-items-center">

        <!-- Brand + Search -->
        <div class="d-flex align-items-center flex-grow-1">
            <!-- Brand -->
            <a class="navbar-brand fw-bold d-flex align-items-center me-3" href="{% url 'main:home' %}">
                <img src="/media/product_needs/narrapro_icon.png" alt="Logo" style="height:30px; margin-right:8px;">
                <span>NarraPro</span>
            </a>

            <!-- Search Field -->
            <form class="flex-grow-1 position-relative" style="max-width:500px;">
                <div class="input-group rounded-pill overflow-hidden bg-white border" style="border-color:#ddd;">
                    <span class="input-group-text bg-white border-0">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input 
                        id="globalSearch"
                        type="text" 
                        class="form-control border-0 shadow-none" 
                        placeholder="Cari lowongan, event, dan narasumber" 
                        aria-label="Search"
                        value="{{ request.GET.q|default:'' }}"
                        autocomplete="off"
                    />
                </div>

                <!-- Popup Preview -->
                <div id="searchPopup" 
                    class="position-absolute start-0 mt-2 w-100 bg-white rounded-3 shadow-lg d-none" 
                    style="max-height: 300px; overflow-y: auto; z-index:1060;">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">ðŸ”Ž Hasil pencarian akan muncul di sini...</li>
                    </ul>
                </div>
            </form>
        </div>

        <!-- Right Side -->
        <div class="d-flex align-items-center ms-3">
            {% if user.is_authenticated %}
                {% if user.role == "event" %}
                <a href="{% url 'lowongan:create' %}" class="btn btn-create d-none d-lg-inline me-3">+ Buat Lowongan</a>
                {% endif %}

                <!-- Dropdown User -->
                <div class="nav-item dropdown user-dropdown">
                    <!-- Desktop: tampil nama -->
                    <a class="nav-link fw-semibold d-none d-lg-block" href="#" id="userDropdown" data-bs-toggle="dropdown">
                        {{ user.first_name|default:user.username }}
                    </a>
                    <!-- Mobile: tampil menu icon -->
                    <a class="nav-link d-lg-none" href="#" id="mobileMenu" data-bs-toggle="dropdown">
                        <i class="bi bi-list fs-3"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>My Profile</a></li>
                        <li><a class="dropdown-item" href="{% url 'main:logout' %}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </div>
            {% else %}
                <!-- Guest -->
                <div class="dropdown">
                    <a class="nav-link d-lg-none" href="#" data-bs-toggle="dropdown"><i class="bi bi-list fs-3"></i></a>
                    <div class="dropdown-menu dropdown-menu-end shadow-sm">
                        <a class="dropdown-item" href="{% url 'main:login' %}">Login</a>
                        <a class="dropdown-item" href="{% url 'main:register' %}">Register</a>
                    </div>
                </div>
                <div class="d-none d-lg-flex">
                    <a class="nav-link" href="{% url 'main:login' %}">Login</a>
                    <a class="nav-link" href="{% url 'main:register' %}">Register</a>
                </div>
            {% endif %}
        </div>
    </div>
</nav>

<!-- Overlay -->
<div id="overlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50" style="z-index:1050;"></div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("globalSearch");
    const popup = document.getElementById("searchPopup");
    const overlay = document.getElementById("overlay");

    let typingTimer;

    const loadingTemplate = `
        <div class="d-flex justify-content-center align-items-center p-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;

    const successTemplate = `
        <ul class="list-group list-group-flush">
            <li class="list-group-item">Lowongan: Backend Developer</li>
            <li class="list-group-item">Event: Konferensi AI 2025</li>
            <li class="list-group-item">Narasumber: Budi Santoso</li>
        </ul>
    `;

    // Show popup + overlay on focus
    searchInput.addEventListener("focus", () => {
        popup.classList.remove("d-none");
        overlay.classList.remove("d-none");
        popup.innerHTML = successTemplate;
    });

    // On input typing â†’ debounce
    searchInput.addEventListener("input", () => {
        clearTimeout(typingTimer);

        typingTimer = setTimeout(() => {
            const query = searchInput.value.trim();
            if (!query) {
                popup.innerHTML = successTemplate;
                return;
            }

            popup.innerHTML = loadingTemplate;

            fetch(`/search/preview/?q=${encodeURIComponent(query)}`)
                .then((res) => res.json())
                .then((data) => {
                    if (data.results && data.results.length > 0) {
                        let html = `<ul class="list-group list-group-flush">`;
                        data.results.forEach((item) => {
                            html += `
                                <li class="list-group-item">
                                    <strong>[${item.type}]</strong> ${item.title}<br/>
                                    <small class="text-muted">${item.subtitle || ""}</small>
                                </li>
                            `;
                        });
                        html += `</ul>`;
                        popup.innerHTML = html;
                    } else {
                        popup.innerHTML = `
                            <div class="p-3 text-muted">Tidak ada hasil ditemukan</div>
                        `;
                    }
                })
                .catch(() => {
                    popup.innerHTML = `
                        <div class="p-3 text-danger">Terjadi kesalahan</div>
                    `;
                });
        }, 1000);
    });

    searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (query.length > 0) {
                const params = new URLSearchParams(window.location.search);
                params.set("q", query);
                params.delete("page");
                window.location.href = `/search/result/?${params.toString()}`;
            }
        }
    });

    overlay.addEventListener("click", () => {
        popup.classList.add("d-none");
        overlay.classList.add("d-none");
    });

    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            popup.classList.add("d-none");
            overlay.classList.add("d-none");
            searchInput.blur();
        }
    });
});
</script>
